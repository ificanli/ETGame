---
description: 
globs: 
alwaysApply: true
---
# analyzer_rules.md

> 本文档用于归档项目分析器相关的强一致性代码规范，所有条目均为自动化分析器和人工审查的强制执行标准。

---

## 1. Entity Await 安全规范
- 在 async/await 环境下，任何 Entity 及其子类对象，await 之后**禁止直接访问** await 前的 Entity 变量。
- 必须在 await 前创建 EntityRef，await 后通过 EntityRef 重新获取 Entity。
- 只要存在执行路径可能在 await 后访问 Entity，均视为违规。
- 支持 `[SkipAwaitEntityCheck]` 特性标记的方法或类可跳过此检查。

## 2. 类循环依赖禁止规范
- 项目中所有类（包括静态类），禁止出现构造函数或方法调用的直接或间接循环依赖。
- 分析器应能检测多级链式依赖导致的循环。

## 3. Entity 成员引用规范
- 除非加 `[AllowEntityMember]` 特性，任何类/结构体**禁止直接声明 Entity 或其子类类型的字段或属性**，包括集合类型（如 List<Entity>、Dictionary<int, Entity>）。
- 允许声明 `EntityRef<T>` 类型字段或属性。
- 允许委托（如 Action<Entity>、Func<Entity, Entity>）类型成员引用 Entity。
- `[AllowEntityMember]` 特性可用于字段或属性，允许特殊场景下直接引用 Entity。

## 4. Entity-MessageObject 引用隔离规范
- Entity 及其子类禁止持有 MessageObject 及其子类的 class 类型成员引用（如 List<MessageObject>、Dictionary<int, MessageObject>）。
- 允许值类型、不可变类型（如 string、ImmutableList<T>）成员。
- 允许临时复制 MessageObject 的值成员，但禁止保存其引用。

## 5. AwaitEntity 检查跳过特性
- `[SkipAwaitEntityCheck]` 可用于方法或类，标记后该作用域内的 await-entity 检查将被跳过。

---

> 本文档为分析器规则专用，所有条目均为强制性规范，违者必纠。 