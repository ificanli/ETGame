<Project Sdk="Microsoft.NET.Sdk">
    <PropertyGroup>
        <TargetFramework>net10.0</TargetFramework>
        <RootNamespace>ET</RootNamespace>
        <LangVersion>default</LangVersion>
        <AssemblyName>ET.Loader</AssemblyName>
        <Configurations>Debug;Release</Configurations>
        <Platforms>AnyCPU</Platforms>
    </PropertyGroup>
    <PropertyGroup>
        <AppendTargetFrameworkToOutputPath>false</AppendTargetFrameworkToOutputPath>
        <SatelliteResourceLanguages>en</SatelliteResourceLanguages>
    </PropertyGroup>
    <PropertyGroup>
        <ETRootDir>$([MSBuild]::EnsureTrailingSlash($([System.IO.Path]::GetFullPath('$(MSBuildThisFileDirectory)..\..\..\' ))))</ETRootDir>
        <MainPackageFile>$(ETRootDir)MainPackage.txt</MainPackageFile>
        <MainPackageDesignTimeProps>$(MSBuildProjectDirectory)/$(BaseIntermediateOutputPath)ET.Loader.MainPackage.g.props</MainPackageDesignTimeProps>
    </PropertyGroup>
    
    <Import Project="$(MainPackageDesignTimeProps)" Condition="'$(DesignTimeBuild)' == 'true' and Exists('$(MainPackageDesignTimeProps)')" />
    
    <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|AnyCPU'">
        <DefineConstants>DOTNET</DefineConstants>
        <OutputPath>$(ETRootDir)Bin</OutputPath> 
        <AllowUnsafeBlocks>false</AllowUnsafeBlocks>
        <TreatWarningsAsErrors>true</TreatWarningsAsErrors>
        <Optimize>false</Optimize>
        <NoWarn>CA2022</NoWarn>
    </PropertyGroup>
    <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|AnyCPU'"> 
        <DefineConstants>DOTNET</DefineConstants>
        <OutputPath>$(ETRootDir)Bin</OutputPath>
        <AllowUnsafeBlocks>false</AllowUnsafeBlocks>
        <TreatWarningsAsErrors>true</TreatWarningsAsErrors>
        <Optimize>true</Optimize>
        <DebugType>full</DebugType>
        <DebugSymbols>true</DebugSymbols>
        <Deterministic>false</Deterministic>
    </PropertyGroup>

    <!-- 生成 IDE 设计时引用文件，解决 ET.Loader 无法显示 MainPackage 引用代码 -->
    <Target Name="GenerateDesignTimePackageProps" BeforeTargets="BeforeBuild" Inputs="$(MainPackageFile)" Outputs="$(MainPackageDesignTimeProps)" Condition="Exists('$(MainPackageFile)')">
        <Exec Command="pwsh -NoProfile -ExecutionPolicy Bypass -File &quot;$(MSBuildThisFileDirectory)Generate-ETLoaderMainPackageProps.ps1&quot; -RootDir &quot;$(ETRootDir.TrimEnd('\'))&quot; -OutputPath &quot;$(MainPackageDesignTimeProps)&quot;" />
    </Target>

    <!-- 动态读取 MainPackage.txt 并生成 Compile 项 -->
    <Target Name="AddPackageCompileItems" BeforeTargets="BeforeBuild;BeforeResolveReferences;CoreCompile">
        <ReadLinesFromFile File="$(MainPackageFile)">
            <Output TaskParameter="Lines" ItemName="PackageNames" />
        </ReadLinesFromFile>
        <ItemGroup>
            <PackageNames Remove="@(PackageNames)" Condition="'%(Identity)' == ''" />
        </ItemGroup>
        <!-- 生成通配符路径 -->
        <ItemGroup>
            <LoaderShareGlobs Include="@(PackageNames->'$(ETRootDir)Packages/%(Identity)/Scripts/Loader/Share/**/*.cs')" />
            <LoaderServerGlobs Include="@(PackageNames->'$(ETRootDir)Packages/%(Identity)/Scripts/Loader/Server/**/*.cs')" />
            <CodeModeLoaderGlobs Include="@(PackageNames->'$(ETRootDir)Packages/%(Identity)/CodeMode/Loader/Server/**/*.cs')" />
        </ItemGroup>
        <!-- 使用 CreateItem 展开通配符 -->
        <CreateItem Include="@(LoaderShareGlobs)">
            <Output TaskParameter="Include" ItemName="Compile" />
        </CreateItem>
        <CreateItem Include="@(LoaderServerGlobs)">
            <Output TaskParameter="Include" ItemName="Compile" />
        </CreateItem>
        <CreateItem Include="@(CodeModeLoaderGlobs)">
            <Output TaskParameter="Include" ItemName="Compile" />
        </CreateItem>
    </Target>
    
    <ItemGroup>
      <PackageReference Include="CommandLineParser" Version="2.9.1" />
    </ItemGroup>
    <ItemGroup>
      <None Update="NLog.config">
        <CopyToOutputDirectory>Always</CopyToOutputDirectory>
      </None>
      <None Include="..\CodeMode\Loader\Server\NLog.config">
        <Link>cn.etetet.loader\CodeMode\Loader\Server\NLog.config</Link>
      </None>
    </ItemGroup>
    <ItemGroup>
      <ProjectReference Include="..\..\cn.etetet.core\DotNet~\ET.Core.csproj" />
    </ItemGroup>
</Project>
