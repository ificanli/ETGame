# 战斗操作和相机操作技术方案

## 文档信息

- **项目名称**: ET游戏战斗系统
- **文档版本**: v1.0
- **创建日期**: 2026-03-01
- **作者**: Claude Code
- **状态**: 待评审

---

## 1. 概述

### 1.1 方案目标

本技术方案旨在实现一个基于摇杆移动、固定俯视相机、自动射击的竖屏射击游戏战斗系统。系统采用服务端权威架构，支持最多12人同屏战斗，使用行为树（BT）管理武器和技能逻辑。

### 1.2 核心特性

- 摇杆移动（固定速度，服务端权威，客户端预测）
- 固定俯视相机（无旋转/缩放）
- 自动射击系统（目标进入范围自动攻击）
- 双武器系统（步枪+冲锋枪，局外装备）
- 阵营系统（友方/敌方/中立）
- 行为树驱动的武器和技能系统
- 目标选择和切换系统

### 1.3 技术栈

- **框架**: ET Framework (ECS架构)
- **网络**: KCP协议
- **寻路**: Recast Navigation
- **相机**: Cinemachine
- **配置**: Luban配置表
- **AI**: 行为树（BT）

---

## 2. 系统架构

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        客户端层                              │
├─────────────────────────────────────────────────────────────┤
│  InputSystem  →  JoystickInput  →  ClientPrediction         │
│       ↓              ↓                    ↓                  │
│  CameraSystem  ←  Unit.Position  ←  ServerReconciliation    │
│       ↓              ↓                    ↓                  │
│  RenderSystem  ←  AnimationSystem  ←  EffectSystem          │
└─────────────────────────────────────────────────────────────┘
                            ↕ (网络协议)
┌─────────────────────────────────────────────────────────────┐
│                        服务端层                              │
├─────────────────────────────────────────────────────────────┤
│  MoveComponent(Joystick模式) → NavMesh校验 → AOI广播       │
│       ↓                              ↓                       │
│  TargetSelectorComponent  →  CampComponent  →  WeaponBT     │
│       ↓                              ↓                       │
│  SkillBT  →  BuffSystem  →  DamageSystem  →  CombatLog     │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 模块划分

#### 2.2.1 移动模块
- **MoveComponent**: 统一移动组件（支持Path和Joystick两种模式）
- **JoystickInputComponent**: 摇杆输入处理和客户端预测
- **NavMeshComponent**: 导航网格校验

#### 2.2.2 战斗模块
- **CampComponent**: 阵营管理
- **TargetSelectorComponent**: 目标选择器
- **WeaponComponent**: 武器管理
- **SkillComponent**: 技能管理
- **BuffComponent**: Buff系统

#### 2.2.3 相机模块
- **CinemachineComponent**: 相机控制

#### 2.2.4 AI模块
- **BTComponent**: 行为树组件
- **BTNodeLibrary**: BT节点库

---

## 3. 移动系统设计

### 3.1 MoveComponent扩展

基于评估报告建议，不新增JoystickMoveComponent，而是扩展现有MoveComponent。

#### 3.1.1 组件结构

```csharp
[ComponentOf(typeof(Unit))]
public class MoveComponent: Entity, IAwake, IDestroy
{
    // ===== 原有字段（路径移动） =====
    public List<float3> Targets = new List<float3>();
    public float3 StartPos;
    public long BeginTime;
    public long StartTime;
    public long NeedTime;
    public long MoveTimer;
    public float Speed;
    public int N;
    public int TurnTime;
    public bool IsTurnHorizontal;
    public quaternion From;
    public quaternion To;
    public ETTask<bool> tcs;

    // ===== 新增字段（摇杆移动） =====
    public MoveMode Mode;           // 移动模式
    public float3 JoystickDir;      // 摇杆方向（归一化）
    public int LastSeq;             // 最后接收的输入序列号
    public long LastInputTime;      // 最后接收输入的时间
    public float3 LastNavMeshPos;   // 上次NavMesh回贴位置
    public float SpeedScale;        // 速度缩放（用于超时减速）
    public float3 LastSyncPos;      // 上次同步位置
    public float3 LastSyncDir;      // 上次同步方向
    public long SyncTimer;          // 同步Timer
}

public enum MoveMode
{
    Path,      // 路径移动（寻路）
    Joystick   // 摇杆移动
}
```

### 3.2 配置表

```csharp
// JoystickMoveConfig.xlsx
public class JoystickMoveConfig
{
    public int ServerTickMs = 33;        // 服务端Tick间隔（30Hz）
    public int SyncIntervalMs = 100;     // 广播间隔（10Hz）
    public float MaxSpeed = 10.0f;       // 最大移动速度（m/s）
    public int InputTimeoutMs = 1000;    // 输入超时时间（ms）
    public float NavMeshCheckDist = 1.0f; // NavMesh检查距离阈值（m）
}
```

---

