# M0 并行开发执行计划

## 背景

M0 版本需要同时推进多个模块，计划 clone 4 个工程，各自用 AI 并行开发，最后合并。

## 现有资产盘点

### 已有包（可直接复用）

| 包名 | ID | 层级 | 状态 | 说明 |
|------|-----|------|------|------|
| cn.etetet.eca | 52 | 2 | ✅ 完成 | ECA 核心框架 |
| cn.etetet.ecanode | 53 | 5 | ✅ 完成 | 撤离点业务（范围检测、倒计时、传送） |
| cn.etetet.equipment | 47 | 5 | ⚠️ 基础版 | 装备穿戴、属性加成（11个文件） |
| cn.etetet.item | 46 | 5 | ⚠️ 基础版 | 物品背包、堆叠（22个文件） |
| cn.etetet.spell | 37 | 5 | ✅ 可用 | 法术/Buff/伤害/目标选择（56个文件） |
| cn.etetet.map | 39 | 5 | ✅ 可用 | 地图/传送/寻路/单位工厂（112个文件） |

### 待创建包

| 包名 | 建议ID | 建议层级 | 用途 |
|------|--------|----------|------|
| cn.etetet.match | 54 | 2 | 匹配队列、模式管理 |
| cn.etetet.battle | 55 | 3 | 战局状态机、结算框架 |

---

## 四个工程分工

### 工程 1：匹配模块

**分支名**: `feature/match`

**目标**: 实现匹配队列 → 战局创建 → 结算返回大厅的完整流程

**涉及包**:
| 操作 | 包 | 说明 |
|------|-----|------|
| 新建 | cn.etetet.match (ID=54) | 匹配队列、模式支持（PVE/1v1/3v3/搜打撤） |
| 新建 | cn.etetet.battle (ID=55) | 战局会话、状态机（准备→战斗→结算）、结算数据 |
| 修改 | cn.etetet.map | 战局初始化流程（FiberInit_Map） |
| 新增 | Proto | 匹配相关消息（C2R_Match, R2C_MatchResult 等） |

**核心任务**:
1. 匹配队列管理（按模式分队列、超时处理）
2. 匹配成功后创建战局（分配地图、通知玩家）
3. 战局状态机（准备 → 战斗 → 结算）
4. 死亡判定 → 战局结束条件
5. 结算数据收集（击杀数、存活状态、财富）
6. 结算完成返回大厅

**测试用例**:
- `Match_BasicFlow_Test` — 基础匹配流程
- `Match_Timeout_Test` — 匹配超时
- `Battle_StateFlow_Test` — 战局状态流转
- `Battle_Settlement_Test` — 结算数据验证

**禁止触碰**（避免冲突）:
- cn.etetet.eca / cn.etetet.ecanode
- cn.etetet.equipment / cn.etetet.item
- cn.etetet.spell 的核心逻辑
- 摇杆/输入系统相关代码

---

### 工程 2：战斗 3C

**分支名**: `feature/combat3c`

**目标**: 摇杆移动 + 自动攻击 + 武器切换 + 技能改造

**涉及包**:
| 操作 | 包 | 说明 |
|------|-----|------|
| 修改 | cn.etetet.map | InputSystemComponent、OperaComponent（摇杆输入） |
| 修改 | cn.etetet.spell | 自动攻击、目标选择、技能释放方式 |
| 修改 | cn.etetet.statesync | 移动同步改造（摇杆方向 → 服务端移动） |
| 可能新建 | cn.etetet.weapon | 武器系统（如果独立出来） |

**核心任务**:
1. 虚拟摇杆实现（参考 9.3 方案）
2. 摇杆方向 → 服务端寻路移动
3. 自动索敌 + 范围自动攻击（参考 9.5 方案）
4. 武器格子 UI + 点击切换
5. 武器差异化（冲锋枪可移动攻击，步枪需停止）
6. 滑动释放指向技能、双击大招

**测试用例**:
- 移动同步测试
- 自动攻击目标选择测试
- 武器切换状态测试

**禁止触碰**:
- cn.etetet.eca / cn.etetet.ecanode
- cn.etetet.equipment / cn.etetet.item
- 匹配和战局相关代码
- FiberInit_Map 中非移动相关的逻辑

**参考文档**:
- `MyBook/说明文档/9.3摇杆移动改造实施文档.md`
- `MyBook/说明文档/9.5范围自动普攻改造方案.md`

---

### 工程 3：ECA 编辑器和地图设计

**分支名**: `feature/eca-editor`

**目标**: GraphView 可视化编辑器 + 地图场景设计

**涉及包**:
| 操作 | 包 | 说明 |
|------|-----|------|
| 修改 | cn.etetet.eca | Editor 目录：GraphView 编辑器 |
| 修改 | cn.etetet.ecanode | 新增 ECA 节点类型（容器、刷怪点） |
| 修改 | cn.etetet.map | 场景资源（Bundles/Scenes）、ECA 配置 |

**核心任务**:
1. ECA GraphView 编辑器（节点创建、连接、拖拽、保存/加载）
2. 新增 ECA 节点类型：
   - 搜索容器（Container）— PointType=3
   - 刷怪点（SpawnPoint）— PointType=2
3. 容器交互逻辑（走近 → 开箱 → 拾取物品）
4. 地图场景设计（布置撤离点、容器、怪物刷新点）
5. 导出完整的 ECA 配置

**测试用例**:
- `Ecanode_ContainerInteract_Test` — 容器交互
- `Ecanode_SpawnPoint_Test` — 刷怪点逻辑

**禁止触碰**:
- cn.etetet.equipment / cn.etetet.item
- cn.etetet.spell 的核心逻辑
- 匹配和战局相关代码
- 摇杆/输入系统

---

### 工程 4：起装和撤离

**分支名**: `feature/loadout`

**目标**: 局外装备选择 → 携带进局 → 撤离带出 → 结算写回

**涉及包**:
| 操作 | 包 | 说明 |
|------|-----|------|
| 修改 | cn.etetet.equipment | 局外装备选择、进局携带 |
| 修改 | cn.etetet.item | 局内背包、拾取物品、带出物品 |
| 修改 | cn.etetet.ecanode | 撤离完成后的物品结算逻辑 |
| 新增 | Proto | 装备携带相关消息 |
| 可能修改 | cn.etetet.login | 角色选择流程加装备选择 |

**核心任务**:
1. 装备选择界面（枪械、英雄选择）
2. 装备数据随玩家传入战局
3. 局内背包系统（拾取搜索到的物品）
4. 撤离时计算带出财富和物品
5. 结算写回（物品存档、财富增加）

**测试用例**:
- `Equipment_Loadout_Test` — 装备携带进局
- `Item_Pickup_Test` — 局内拾取
- `Ecanode_EvacuationReward_Test` — 撤离奖励结算

**禁止触碰**:
- cn.etetet.eca 的 Editor 代码
- cn.etetet.spell 的核心逻辑
- 匹配队列和战局状态机
- 摇杆/输入系统

---

## 冲突预防策略

### 第一步：基础设施提交（合并前在主分支完成）

在 fork 之前，先在主分支上做一次基础设施提交：

```
基础设施提交内容：
1. MainPackage.txt — 一次性加入所有新包名
2. 创建 cn.etetet.match 空壳（packagegit.json, PackageType.cs, AGENTS.md）
3. 创建 cn.etetet.battle 空壳（packagegit.json, PackageType.cs, AGENTS.md）
4. 重新生成 g.props（手动运行 4 个 PowerShell 脚本）
5. 编译验证通过
```

### 共享文件冲突矩阵

| 文件 | 工程1 | 工程2 | 工程3 | 工程4 | 冲突风险 |
|------|-------|-------|-------|-------|----------|
| MainPackage.txt | - | - | - | - | ✅ 基础设施已处理 |
| Proto/*.proto | 改 | - | - | 改 | ⚠️ 不同文件即可 |
| FiberInit_Map.cs | 改 | - | - | - | 低 |
| ECAPointComponentSystem.cs | - | - | 改 | 改 | ⚠️ 需协调 |
| ECALoader.cs | - | - | 改 | - | 低 |
| PlayerEvacuationComponentSystem.cs | - | - | - | 改 | 低 |

### Proto 文件分配

为避免 Proto 冲突，各工程使用不同的 proto 文件：

| 工程 | Proto 文件 | 消息号段 |
|------|-----------|---------|
| 工程1 | `MatchMessage.proto` | 新文件 |
| 工程2 | 不新增 proto（复用现有移动/技能消息） | - |
| 工程3 | 不新增 proto（Editor 工具，无网络消息） | - |
| 工程4 | `LoadoutMessage.proto` | 新文件 |

### ECAPointComponentSystem.cs 冲突处理

工程 3 和工程 4 都可能修改 `OnPlayerEnter` 的 `switch (self.PointType)` 分支：
- **工程 3** 添加 `case 2` (SpawnPoint) 和 `case 3` (Container)
- **工程 4** 修改 `case 1` (EvacuationPoint) 的奖励逻辑

**建议**：工程 3 只添加新 case，不改 case 1；工程 4 只改 case 1，不加新 case。合并时手动合并此文件。

---

## 合并顺序

```
主分支（基础设施提交）
    ├── 1. 合入 feature/match（匹配模块，最上游）
    ├── 2. 合入 feature/loadout（起装撤离，依赖匹配结算接口）
    ├── 3. 合入 feature/eca-editor（ECA编辑器，独立性强）
    └── 4. 合入 feature/combat3c（战斗3C，最独立，最后合入）
```

**理由**：
1. 匹配模块定义了战局生命周期接口，其他模块可能需要对接
2. 起装撤离需要结算框架（来自匹配模块的 battle 包）
3. ECA 编辑器独立性强，合入顺序灵活
4. 战斗 3C 完全独立，放最后不影响任何模块

---

## 每个工程的 CLAUDE.md 补充

每个 clone 工程的根目录应补充一份开发约束，告诉 AI：

```markdown
## 当前分支任务
- 分支名: feature/xxx
- 负责模块: xxx
- 禁止修改的文件: [列表]
- 可修改的包: [列表]
```

这样 AI 不会越界修改其他模块的代码。

---

## 时间估算

| 工程 | 预计工作量 | 说明 |
|------|-----------|------|
| 工程1 匹配模块 | 2-3 天 | 新包较多，但逻辑清晰 |
| 工程2 战斗3C | 3-5 天 | 客户端改造多，调参耗时 |
| 工程3 ECA编辑器 | 2-3 天 | GraphView + 新节点类型 |
| 工程4 起装撤离 | 2-3 天 | 改造现有包 + 结算逻辑 |
| 基础设施 + 合并 | 1 天 | 预处理 + 冲突解决 |

**并行开发总耗时**：约 1 周（取最长的战斗 3C）

---

## 执行步骤

### Day 0：准备阶段
1. [x] 在主分支完成基础设施提交（新包空壳、MainPackage.txt、g.props）
2. [x] 编译验证通过
3. [ ] Clone 4 份工程（同一分支 MySpawn）
4. [x] 每个工程补充模块专属的 CLAUDE.md 约束（见 MyBook/进度文档/分支约束/）

### 开发模式说明
- **单分支多 Clone**：4 个工程都在 MySpawn 分支上，各自独立开发
- 每个 Clone 的根目录 CLAUDE.md 替换为对应的约束文件内容
- 开发完成后手动将各工程的改动合并回主工程

### Day 1-5：并行开发
- 各工程按任务列表独立开发
- 每个工程完成后先自测（`dotnet build` + 运行测试）
- 有跨模块问题在群里同步

### Day 6：合并
1. [ ] 工程1（匹配模块）代码合入主工程
2. [ ] 工程4（起装撤离）代码合入（解决可能的 proto 冲突）
3. [ ] 工程3（ECA编辑器）代码合入（解决 ECAPointComponentSystem 冲突）
4. [ ] 工程2（战斗3C）代码合入
5. [ ] 全量编译验证
6. [ ] 端到端测试：匹配 → 进局 → 战斗 → 搜索 → 撤离 → 结算

---

## 最后更新时间：2026-02-27
