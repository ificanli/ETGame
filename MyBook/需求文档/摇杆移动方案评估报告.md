# æ‘‡æ†ç§»åŠ¨æ–¹æ¡ˆè¯„ä¼°æŠ¥å‘Š

## è¯„ä¼°æ—¥æœŸï¼š2026-03-01

---

## 1. æ€»ä½“è¯„ä»·

**ç»“è®º**ï¼šæ–¹æ¡ˆæ•´ä½“è®¾è®¡åˆç†ï¼Œä½†å­˜åœ¨ **5 ä¸ªå…³é”®é—®é¢˜** å’Œ **8 ä¸ªéœ€è¦ä¼˜åŒ–çš„ç‚¹**ã€‚

**é£é™©ç­‰çº§**ï¼šğŸŸ¡ ä¸­ç­‰é£é™©ï¼ˆéœ€è¦ä¿®æ­£åå®æ–½ï¼‰

---

## 2. å…³é”®é—®é¢˜ï¼ˆå¿…é¡»è§£å†³ï¼‰

### âŒ é—®é¢˜ 1ï¼šJoystickMoveComponent ä¸ MoveComponent å†²çª

**é—®é¢˜æè¿°**ï¼š
- æ–¹æ¡ˆæ–°å¢äº† `JoystickMoveComponent`ï¼Œä½†ç°æœ‰ `MoveComponent` ä»ç„¶å­˜åœ¨
- ä¸¤ä¸ªç»„ä»¶éƒ½ç®¡ç† Unit çš„ä½ç½®å’Œç§»åŠ¨çŠ¶æ€ï¼Œä¼šäº§ç”Ÿå†²çª
- æ–‡æ¡£ä¸­æåˆ°"åœæ­¢æ—§ MoveComponent"ï¼Œä½†æ²¡æœ‰æ˜ç¡®äº’æ–¥æœºåˆ¶

**æ½œåœ¨åæœ**ï¼š
1. æ‘‡æ†ç§»åŠ¨å’Œè·¯å¾„ç§»åŠ¨åŒæ—¶ç”Ÿæ•ˆï¼Œå¯¼è‡´ä½ç½®æŠ–åŠ¨
2. æŠ€èƒ½ä½ç§»ï¼ˆå¦‚å†²é”‹ï¼‰å¯èƒ½è¢«æ‘‡æ†è¾“å…¥æ‰“æ–­
3. æœåŠ¡ç«¯çŠ¶æ€ä¸ä¸€è‡´

**å»ºè®®æ–¹æ¡ˆ**ï¼š

**æ–¹æ¡ˆ Aï¼ˆæ¨èï¼‰**ï¼šç»Ÿä¸€åˆ° MoveComponent
```csharp
// åœ¨ MoveComponent ä¸­æ–°å¢å­—æ®µ
public enum MoveMode
{
    Path,      // è·¯å¾„ç§»åŠ¨ï¼ˆåŸæœ‰ï¼‰
    Joystick   // æ‘‡æ†ç§»åŠ¨ï¼ˆæ–°å¢ï¼‰
}

public MoveMode Mode;
public float3 JoystickDir;  // æ‘‡æ†æ–¹å‘
public int LastSeq;
```

**æ–¹æ¡ˆ B**ï¼šæ˜ç¡®äº’æ–¥è§„åˆ™
```csharp
// åœ¨ Unit ä¸Šåªèƒ½æŒ‚è½½ä¸€ä¸ªç§»åŠ¨ç»„ä»¶
// JoystickMoveComponent.Awake æ—¶æ£€æŸ¥å¹¶ç§»é™¤ MoveComponent
// æŠ€èƒ½ä½ç§»æ—¶ä¸´æ—¶ç¦ç”¨ JoystickMoveComponent
```

---

### âŒ é—®é¢˜ 2ï¼šæœåŠ¡ç«¯ Tick é¢‘ç‡æœªæ˜ç¡®

**é—®é¢˜æè¿°**ï¼š
- æ–‡æ¡£æåˆ°"æŒ‰ Tick æ¨è¿›ä½ç½®"ï¼Œä½†æ²¡æœ‰è¯´æ˜ Tick é¢‘ç‡
- æœåŠ¡ç«¯ç§»åŠ¨ Timer çš„é—´éš”æ—¶é—´æœªå®šä¹‰
- ä¸åŒ Tick é¢‘ç‡ä¼šä¸¥é‡å½±å“ç§»åŠ¨æ‰‹æ„Ÿå’Œæ€§èƒ½

**æ½œåœ¨åæœ**ï¼š
1. Tick å¤ªå¿«ï¼ˆå¦‚ 60Hzï¼‰ï¼šæœåŠ¡ç«¯ CPU å‹åŠ›å¤§ï¼Œ100 äººåŒå±å¯èƒ½å¡é¡¿
2. Tick å¤ªæ…¢ï¼ˆå¦‚ 10Hzï¼‰ï¼šç§»åŠ¨ä¸æµç•…ï¼Œè½¬å‘å»¶è¿Ÿæ˜æ˜¾
3. ä¸å®¢æˆ·ç«¯å‘é€é¢‘ç‡ï¼ˆ20Hzï¼‰ä¸åŒ¹é…ï¼Œå¯¼è‡´è¾“å…¥æµªè´¹

**å»ºè®®æ–¹æ¡ˆ**ï¼š
```csharp
// é…ç½®è¡¨æ–°å¢
public int JoystickServerTickMs = 50;  // æœåŠ¡ç«¯ Tick é—´éš”ï¼ˆ20Hzï¼‰

// è¯´æ˜ï¼š
// - 20Hz æ˜¯ MOBA æ¸¸æˆå¸¸è§æœåŠ¡ç«¯å¸§ç‡
// - ä¸å®¢æˆ·ç«¯å‘é€é¢‘ç‡ï¼ˆ20Hzï¼‰åŒ¹é…
// - 100 äººåŒå±æ¯ç§’ 2000 æ¬¡ç§»åŠ¨è®¡ç®—ï¼Œå¯æ¥å—
```

---

### âŒ é—®é¢˜ 3ï¼šå®¢æˆ·ç«¯é¢„æµ‹ç¼ºå¤±

**é—®é¢˜æè¿°**ï¼š
- æ–¹æ¡ˆä¸­å®¢æˆ·ç«¯å‘é€è¾“å…¥åï¼Œç­‰å¾…æœåŠ¡ç«¯è¿”å› `M2C_JoystickState` æ‰æ›´æ–°ä½ç½®
- ç½‘ç»œå»¶è¿Ÿ 50-100ms æ—¶ï¼Œæ‘‡æ†æ“ä½œä¼šæœ‰æ˜æ˜¾å»¶è¿Ÿæ„Ÿ
- æ–‡æ¡£æåˆ°"è‡ªå·±å•ä½åšå¹³æ»‘å›æ­£"ï¼Œä½†æ²¡æœ‰è¯´æ˜å®¢æˆ·ç«¯é¢„æµ‹æœºåˆ¶

**æ½œåœ¨åæœ**ï¼š
1. æ“ä½œæ‰‹æ„Ÿå·®ï¼Œç©å®¶æ„Ÿè§‰"æ‹–æ³¥å¸¦æ°´"
2. é«˜å»¶è¿Ÿç¯å¢ƒä¸‹å‡ ä¹æ— æ³•æ“ä½œ
3. ä¸å…¶ä»– MOBA æ¸¸æˆç›¸æ¯”ä½“éªŒæ˜æ˜¾è½å

**å»ºè®®æ–¹æ¡ˆ**ï¼š
```csharp
// å®¢æˆ·ç«¯ç«‹å³é¢„æµ‹ç§»åŠ¨
public static void SendJoystickInput(this InputSystemComponent self, float3 dir)
{
    // 1. å‘é€åˆ°æœåŠ¡ç«¯
    C2M_JoystickInput msg = C2M_JoystickInput.Create();
    msg.MoveDir = dir;
    msg.Seq = ++self.LastSendSeq;
    self.Send(msg);

    // 2. ç«‹å³æœ¬åœ°é¢„æµ‹ï¼ˆå…³é”®ï¼ï¼‰
    Unit myUnit = self.GetMyUnit();
    myUnit.Position += dir * speed * Time.deltaTime;

    // 3. è®°å½•é¢„æµ‹å†å²ï¼ˆç”¨äºæœåŠ¡ç«¯å›æ­£ï¼‰
    self.PredictionHistory.Add(new PredictionRecord
    {
        Seq = msg.Seq,
        Position = myUnit.Position
    });
}

// æ”¶åˆ°æœåŠ¡ç«¯çŠ¶æ€æ—¶å›æ­£
public static void OnJoystickState(this Unit self, M2C_JoystickState msg)
{
    if (self.IsMyUnit())
    {
        // è®¡ç®—è¯¯å·®
        float error = math.distance(self.Position, msg.Position);

        if (error > 0.5f)  // è¯¯å·®è¿‡å¤§ï¼Œç¡¬å¯¹é½
        {
            self.Position = msg.Position;
        }
        else if (error > 0.1f)  // å°è¯¯å·®ï¼Œå¹³æ»‘å›æ­£
        {
            self.Position = math.lerp(self.Position, msg.Position, 0.3f);
        }
        // è¯¯å·®å¾ˆå°ï¼Œå¿½ç•¥ï¼ˆä¿¡ä»»å®¢æˆ·ç«¯é¢„æµ‹ï¼‰
    }
    else
    {
        // å…¶ä»–ç©å®¶ç›´æ¥æ’å€¼
        self.Position = msg.Position;
    }
}
```

---

### âŒ é—®é¢˜ 4ï¼šNavMesh å›è´´æ€§èƒ½é—®é¢˜

**é—®é¢˜æè¿°**ï¼š
- æ–¹æ¡ˆä¸­æ¯æ¬¡ Tick éƒ½è°ƒç”¨ `RecastFindNearestPoint` è¿›è¡Œ NavMesh å›è´´
- è¿™æ˜¯ä¸€ä¸ªç›¸å¯¹æ˜‚è´µçš„æ“ä½œï¼ˆéœ€è¦æŸ¥è¯¢ NavMesh æ•°æ®ç»“æ„ï¼‰
- 100 äººåŒå±ï¼Œ20Hz Tickï¼Œæ¯ç§’ 2000 æ¬¡ NavMesh æŸ¥è¯¢

**æ½œåœ¨åæœ**ï¼š
1. æœåŠ¡ç«¯ CPU å ç”¨è¿‡é«˜
2. å¤§è§„æ¨¡æˆ˜æ–—æ—¶æœåŠ¡å™¨å¡é¡¿
3. å¯èƒ½éœ€è¦é™ä½ Tick é¢‘ç‡ï¼Œå½±å“æ‰‹æ„Ÿ

**å»ºè®®æ–¹æ¡ˆ**ï¼š

**ä¼˜åŒ– A**ï¼šæ¡ä»¶å›è´´
```csharp
// åªåœ¨å¿…è¦æ—¶å›è´´
public static void TickMove(this JoystickMoveComponent self)
{
    Unit unit = self.GetParent<Unit>();
    float3 targetPos = unit.Position + self.MoveDir * speed * dt;

    // æ£€æŸ¥æ˜¯å¦éœ€è¦å›è´´ï¼ˆè·ç¦»ä¸Šæ¬¡å›è´´ä½ç½®è¾ƒè¿œæ—¶æ‰å›è´´ï¼‰
    if (math.distance(targetPos, self.LastNavMeshPos) > 1.0f)
    {
        targetPos = pathfinding.RecastFindNearestPoint(targetPos);
        self.LastNavMeshPos = targetPos;
    }

    unit.Position = targetPos;
}
```

**ä¼˜åŒ– B**ï¼šå¼‚æ­¥å›è´´
```csharp
// NavMesh æŸ¥è¯¢æ”¾åˆ°åå°çº¿ç¨‹
// ä¸»çº¿ç¨‹å…ˆç§»åŠ¨ï¼Œåå°çº¿ç¨‹å¼‚æ­¥æ ¡éªŒ
// å‘ç°ç©¿å¢™æ—¶å†å›æ­£ï¼ˆå¤§éƒ¨åˆ†æƒ…å†µä¸éœ€è¦å›è´´ï¼‰
```

---

### âŒ é—®é¢˜ 5ï¼šè¾“å…¥åºåˆ—å·ï¼ˆSeqï¼‰å›æ»šé—®é¢˜

**é—®é¢˜æè¿°**ï¼š
- åè®®ä¸­ä½¿ç”¨ `int32 Seq`ï¼Œä½†æ²¡æœ‰å¤„ç†æº¢å‡ºå’Œå›æ»š
- `int32` æœ€å¤§å€¼ 2,147,483,647ï¼ŒæŒ‰ 20Hz å‘é€ï¼Œçº¦ 1245 å¤©åæº¢å‡º
- æº¢å‡ºå Seq å˜ä¸ºè´Ÿæ•°ï¼Œæ¯”è¾ƒé€»è¾‘ä¼šå‡ºé”™

**æ½œåœ¨åæœ**ï¼š
1. é•¿æ—¶é—´è¿è¡Œå Seq æº¢å‡ºï¼Œå¯¼è‡´è¾“å…¥è¢«æ‹’ç»
2. æœåŠ¡ç«¯åˆ¤æ–­ `newSeq > oldSeq` å¤±æ•ˆ
3. ç©å®¶çªç„¶æ— æ³•ç§»åŠ¨

**å»ºè®®æ–¹æ¡ˆ**ï¼š
```csharp
// ä½¿ç”¨å¾ªç¯æ¯”è¾ƒ
public static bool IsSeqNewer(int newSeq, int oldSeq)
{
    // å¤„ç†æº¢å‡ºæƒ…å†µ
    int diff = newSeq - oldSeq;

    // å¦‚æœå·®å€¼åœ¨åˆç†èŒƒå›´å†…ï¼ˆ-1000 åˆ° 1000ï¼‰ï¼Œè®¤ä¸ºæ˜¯æ­£å¸¸é€’å¢
    // å¦‚æœå·®å€¼è¿‡å¤§ï¼Œè¯´æ˜å‘ç”Ÿäº†æº¢å‡º
    if (diff > 0 && diff < 1000)
        return true;
    if (diff < -2000000000)  // æº¢å‡ºå›æ»š
        return true;

    return false;
}

// æˆ–è€…ä½¿ç”¨ uint32ï¼ˆæ— ç¬¦å·ï¼‰+ æ¨¡è¿ç®—
```

---

## 3. éœ€è¦ä¼˜åŒ–çš„ç‚¹

### âš ï¸ ä¼˜åŒ– 1ï¼šå¹¿æ’­ä¼˜åŒ–ä¸è¶³

**é—®é¢˜**ï¼š
- æ–¹æ¡ˆä¸­æœåŠ¡ç«¯å›ºå®šé¢‘ç‡å¹¿æ’­ `M2C_JoystickState`
- å³ä½¿ç©å®¶é™æ­¢ä¸åŠ¨ï¼Œä¹Ÿä¼šæŒç»­å¹¿æ’­
- AOI èŒƒå›´å†… 50 äººï¼Œæ¯äºº 10Hz å¹¿æ’­ï¼Œæ¯ç§’ 500 æ¡æ¶ˆæ¯

**å»ºè®®**ï¼š
```csharp
// åªåœ¨çŠ¶æ€å˜åŒ–æ—¶å¹¿æ’­
public static void TickSync(this JoystickMoveComponent self)
{
    // æ–¹å‘æˆ–ä½ç½®å˜åŒ–è¶…è¿‡é˜ˆå€¼æ‰å¹¿æ’­
    if (math.distance(self.LastSyncPos, unit.Position) > 0.1f ||
        math.distance(self.LastSyncDir, self.MoveDir) > 0.01f)
    {
        BroadcastJoystickState();
        self.LastSyncPos = unit.Position;
        self.LastSyncDir = self.MoveDir;
    }
}
```

---

### âš ï¸ ä¼˜åŒ– 2ï¼šåœæ­¢æ¶ˆæ¯å†—ä½™

**é—®é¢˜**ï¼š
- åè®®ä¸­æœ‰ `IsStop` å­—æ®µï¼Œåˆæœ‰ `IsMoving` å­—æ®µ
- è¯­ä¹‰é‡å¤ï¼Œå®¹æ˜“æ··æ·†

**å»ºè®®**ï¼š
```proto
// åªä¿ç•™ä¸€ä¸ªçŠ¶æ€å­—æ®µ
message C2M_JoystickInput
{
    int32 Seq = 2;
    Unity.Mathematics.float3 MoveDir = 3;  // é•¿åº¦ä¸º 0 è¡¨ç¤ºåœæ­¢
    // åˆ é™¤ IsStop å­—æ®µ
}
```

---

### âš ï¸ ä¼˜åŒ– 3ï¼šæ–¹å‘å½’ä¸€åŒ–ä½ç½®ä¸å½“

**é—®é¢˜**ï¼š
- æ–‡æ¡£æåˆ°åœ¨ Handler ä¸­å½’ä¸€åŒ– `MoveDir`
- ä½†å®¢æˆ·ç«¯å·²ç»å‘é€äº†å½’ä¸€åŒ–çš„æ–¹å‘ï¼ŒæœåŠ¡ç«¯å†å½’ä¸€åŒ–æ˜¯å†—ä½™çš„
- å¦‚æœå®¢æˆ·ç«¯å‘é€éå½’ä¸€åŒ–æ–¹å‘ï¼Œè¯´æ˜å®¢æˆ·ç«¯æœ‰é—®é¢˜ï¼Œåº”è¯¥æ‹’ç»è€Œä¸æ˜¯ä¿®æ­£

**å»ºè®®**ï¼š
```csharp
// æœåŠ¡ç«¯æ ¡éªŒè€Œä¸æ˜¯ä¿®æ­£
public static void Handle(this C2M_JoystickInputHandler self, Unit unit, C2M_JoystickInput msg)
{
    float len = math.length(msg.MoveDir);

    // æ ¡éªŒåˆæ³•æ€§
    if (len > 1.1f)  // å…è®¸å°è¯¯å·®
    {
        Log.Warning($"Invalid MoveDir length: {len}, reject");
        return;  // æ‹’ç»éæ³•è¾“å…¥
    }

    // ç›´æ¥ä½¿ç”¨ï¼Œä¸ä¿®æ­£
    component.MoveDir = msg.MoveDir;
}
```

---

### âš ï¸ ä¼˜åŒ– 4ï¼šç¼ºå°‘é€Ÿåº¦é™åˆ¶

**é—®é¢˜**ï¼š
- æ–¹æ¡ˆä¸­ç§»åŠ¨é€Ÿåº¦å®Œå…¨ä¾èµ– `NumericComponent.Speed`
- æ²¡æœ‰æœ€å¤§é€Ÿåº¦é™åˆ¶
- å¦‚æœé…ç½®é”™è¯¯æˆ–è¢«å¤–æŒ‚ä¿®æ”¹ï¼Œå¯èƒ½å‡ºç°è¶…é«˜é€Ÿç§»åŠ¨

**å»ºè®®**ï¼š
```csharp
// æœåŠ¡ç«¯é™åˆ¶æœ€å¤§é€Ÿåº¦
float speed = unit.NumericComponent.GetAsFloat(NumericType.Speed);
speed = math.min(speed, MAX_MOVE_SPEED);  // ä¾‹å¦‚ 10 m/s

// åŒæ—¶æ£€æµ‹å¼‚å¸¸ç§»åŠ¨
float distance = math.distance(oldPos, newPos);
if (distance > speed * dt * 1.5f)  // è¶…è¿‡ç†è®ºæœ€å¤§è·ç¦»
{
    Log.Warning($"Abnormal movement detected: {distance}");
    // å›æ»šä½ç½®æˆ–è¸¢å‡ºç©å®¶
}
```

---

### âš ï¸ ä¼˜åŒ– 5ï¼šç¼ºå°‘è¾“å…¥é¢‘ç‡é™åˆ¶

**é—®é¢˜**ï¼š
- å®¢æˆ·ç«¯å¯ä»¥æ— é™é¢‘ç‡å‘é€ `C2M_JoystickInput`
- æ¶æ„å®¢æˆ·ç«¯å¯ä»¥æ¯å¸§å‘é€ï¼ˆ60Hzï¼‰ï¼Œé€ æˆæœåŠ¡ç«¯å‹åŠ›
- æ²¡æœ‰é˜²åˆ·æœºåˆ¶

**å»ºè®®**ï¼š
```csharp
// æœåŠ¡ç«¯é™åˆ¶è¾“å…¥é¢‘ç‡
public static void Handle(this C2M_JoystickInputHandler self, Unit unit, C2M_JoystickInput msg)
{
    JoystickMoveComponent comp = unit.GetComponent<JoystickMoveComponent>();

    long now = TimeInfo.Instance.ServerNow();
    long interval = now - comp.LastInputTime;

    // é™åˆ¶æœ€å°é—´éš”ï¼ˆä¾‹å¦‚ 40msï¼Œå³æœ€é«˜ 25Hzï¼‰
    if (interval < 40)
    {
        // å¿½ç•¥è¿‡äºé¢‘ç¹çš„è¾“å…¥
        return;
    }

    comp.LastInputTime = now;
    // å¤„ç†è¾“å…¥...
}
```

---

### âš ï¸ ä¼˜åŒ– 6ï¼šè¶…æ—¶æ—¶é—´è¿‡é•¿

**é—®é¢˜**ï¼š
- æ–‡æ¡£å»ºè®®çš„ `InputTimeoutMs` æ²¡æœ‰å…·ä½“æ•°å€¼
- å¦‚æœè®¾ç½®è¿‡é•¿ï¼ˆå¦‚ 5 ç§’ï¼‰ï¼Œç½‘ç»œæ–­å¼€åè§’è‰²ä¼š"å¹½çµå‰è¿›"å¾ˆä¹…
- å¦‚æœè®¾ç½®è¿‡çŸ­ï¼ˆå¦‚ 100msï¼‰ï¼Œç½‘ç»œæŠ–åŠ¨ä¼šå¯¼è‡´é¢‘ç¹åœæ­¢

**å»ºè®®**ï¼š
```csharp
// åˆ†çº§è¶…æ—¶
public const int INPUT_TIMEOUT_WARNING = 500;   // 0.5 ç§’ï¼Œå¼€å§‹å‡é€Ÿ
public const int INPUT_TIMEOUT_STOP = 1000;     // 1 ç§’ï¼Œå®Œå…¨åœæ­¢

public static void CheckTimeout(this JoystickMoveComponent self)
{
    long now = TimeInfo.Instance.ServerNow();
    long elapsed = now - self.LastInputTime;

    if (elapsed > INPUT_TIMEOUT_STOP)
    {
        self.Stop();  // å®Œå…¨åœæ­¢
    }
    else if (elapsed > INPUT_TIMEOUT_WARNING)
    {
        // é€æ¸å‡é€Ÿ
        float factor = 1.0f - (elapsed - INPUT_TIMEOUT_WARNING) / 500f;
        self.SpeedScale = math.max(0, factor);
    }
}
```

---

### âš ï¸ ä¼˜åŒ– 7ï¼šç¼ºå°‘æ–­çº¿é‡è¿å¤„ç†

**é—®é¢˜**ï¼š
- ç©å®¶æ–­çº¿é‡è¿åï¼Œ`JoystickMoveComponent` çŠ¶æ€å¦‚ä½•æ¢å¤ï¼Ÿ
- `LastSeq` å¦‚ä½•åŒæ­¥ï¼Ÿ
- æ˜¯å¦éœ€è¦é‡æ–°å‘é€å½“å‰çŠ¶æ€ï¼Ÿ

**å»ºè®®**ï¼š
```csharp
// é‡è¿æ—¶é‡ç½®çŠ¶æ€
public static void OnReconnect(this Unit unit)
{
    JoystickMoveComponent comp = unit.GetComponent<JoystickMoveComponent>();
    if (comp != null)
    {
        comp.Stop();  // åœæ­¢ç§»åŠ¨
        comp.LastSeq = 0;  // é‡ç½®åºåˆ—å·

        // å‘é€å½“å‰çŠ¶æ€ç»™å®¢æˆ·ç«¯
        M2C_JoystickState msg = M2C_JoystickState.Create();
        msg.Position = unit.Position;
        msg.IsMoving = false;
        unit.SendToClient(msg);
    }
}
```

---

### âš ï¸ ä¼˜åŒ– 8ï¼šç¼ºå°‘æŠ€èƒ½æ‰“æ–­ç§»åŠ¨çš„å¤„ç†

**é—®é¢˜**ï¼š
- æŸäº›æŠ€èƒ½ï¼ˆå¦‚çœ©æ™•ã€å®šèº«ï¼‰åº”è¯¥ç¦æ­¢ç§»åŠ¨
- æ–¹æ¡ˆä¸­æ²¡æœ‰è¯´æ˜å¦‚ä½•å¤„ç†æŠ€èƒ½å¯¹ç§»åŠ¨çš„å½±å“
- `JoystickMoveComponent` å’ŒæŠ€èƒ½ç³»ç»Ÿå¦‚ä½•äº¤äº’ï¼Ÿ

**å»ºè®®**ï¼š
```csharp
// åœ¨ TickMove ä¸­æ£€æŸ¥ç§»åŠ¨é™åˆ¶
public static void TickMove(this JoystickMoveComponent self)
{
    Unit unit = self.GetParent<Unit>();

    // æ£€æŸ¥æ˜¯å¦å¯ä»¥ç§»åŠ¨
    if (unit.HasBuff(BuffType.Stun) ||
        unit.HasBuff(BuffType.Root) ||
        unit.IsCasting())  // æ–½æ³•ä¸­
    {
        return;  // ä¸ç§»åŠ¨
    }

    // æ­£å¸¸ç§»åŠ¨é€»è¾‘...
}

// æŠ€èƒ½æ–½æ”¾æ—¶åœæ­¢æ‘‡æ†ç§»åŠ¨
public static void OnSpellStart(this Unit unit)
{
    SpellConfig config = GetSpellConfig(spellId);
    if (config.InterruptMove)
    {
        unit.GetComponent<JoystickMoveComponent>()?.Pause();
    }
}
```

---

## 4. æ¶æ„å»ºè®®

### å»ºè®® 1ï¼šç»Ÿä¸€ç§»åŠ¨ç³»ç»Ÿ

ä¸è¦æ–°å¢ `JoystickMoveComponent`ï¼Œè€Œæ˜¯æ‰©å±•ç°æœ‰ `MoveComponent`ï¼š

```csharp
// MoveComponent æ”¯æŒä¸¤ç§æ¨¡å¼
public enum MoveMode
{
    Path,      // è·¯å¾„ç§»åŠ¨ï¼ˆå¯»è·¯ï¼‰
    Joystick   // æ‘‡æ†ç§»åŠ¨
}

// ç»Ÿä¸€æ¥å£
public static async ETTask<bool> MoveToAsync(this MoveComponent self, List<float3> path)
{
    self.Mode = MoveMode.Path;
    // åŸæœ‰é€»è¾‘...
}

public static void SetJoystickInput(this MoveComponent self, float3 dir)
{
    if (self.Mode != MoveMode.Joystick)
    {
        self.Stop(false);  // åœæ­¢è·¯å¾„ç§»åŠ¨
        self.Mode = MoveMode.Joystick;
        self.StartJoystickMove();
    }

    self.JoystickDir = dir;
}
```

**ä¼˜åŠ¿**ï¼š
1. é¿å…ä¸¤ä¸ªç»„ä»¶å†²çª
2. ä»£ç å¤ç”¨ï¼ˆTimerã€äº‹ä»¶ã€AOI åŒæ­¥ï¼‰
3. æ›´å®¹æ˜“ç»´æŠ¤

---

### å»ºè®® 2ï¼šå®¢æˆ·ç«¯é¢„æµ‹æ˜¯å¿…é¡»çš„

è¿™ä¸æ˜¯ä¼˜åŒ–ï¼Œè€Œæ˜¯åŸºæœ¬è¦æ±‚ã€‚æ²¡æœ‰å®¢æˆ·ç«¯é¢„æµ‹çš„æ‘‡æ†ç§»åŠ¨æ‰‹æ„Ÿä¼šéå¸¸å·®ã€‚

**å‚è€ƒå®ç°**ï¼š
1. å®¢æˆ·ç«¯å‘é€è¾“å…¥åç«‹å³æœ¬åœ°ç§»åŠ¨
2. è®°å½•é¢„æµ‹å†å²ï¼ˆæœ€è¿‘ 1 ç§’çš„è¾“å…¥å’Œä½ç½®ï¼‰
3. æ”¶åˆ°æœåŠ¡ç«¯çŠ¶æ€æ—¶ï¼Œå›æ»šåˆ°å¯¹åº” Seq çš„ä½ç½®ï¼Œé‡æ–°åº”ç”¨åç»­è¾“å…¥
4. å¦‚æœè¯¯å·®å°ï¼Œå¹³æ»‘æ’å€¼ï¼›è¯¯å·®å¤§ï¼Œç¡¬å¯¹é½

---

### å»ºè®® 3ï¼šåˆ†ç¦»è¾“å…¥å’Œç§»åŠ¨

```csharp
// InputSystemComponentï¼šè´Ÿè´£é‡‡é›†è¾“å…¥
// JoystickInputComponentï¼šè´Ÿè´£è¾“å…¥ä¸ŠæŠ¥å’Œé¢„æµ‹
// MoveComponentï¼šè´Ÿè´£å®é™…ç§»åŠ¨ï¼ˆæœåŠ¡ç«¯æƒå¨ï¼‰

// è¿™æ ·èŒè´£æ›´æ¸…æ™°ï¼Œä¹Ÿæ›´å®¹æ˜“æµ‹è¯•
```

---

## 5. æ€§èƒ½è¯„ä¼°

### 5.1 ç½‘ç»œå¸¦å®½

**å®¢æˆ·ç«¯ä¸Šè¡Œ**ï¼š
- é¢‘ç‡ï¼š20Hz
- æ¶ˆæ¯å¤§å°ï¼šçº¦ 40 å­—èŠ‚ï¼ˆRpcId + Seq + float3 + bool + ClientTimeï¼‰
- å¸¦å®½ï¼š40 * 20 = 800 å­—èŠ‚/ç§’ = 0.8 KB/s âœ… å¯æ¥å—

**æœåŠ¡ç«¯ä¸‹è¡Œ**ï¼š
- é¢‘ç‡ï¼š10Hzï¼ˆä¼˜åŒ–åï¼Œåªåœ¨å˜åŒ–æ—¶å‘é€ï¼‰
- AOI èŒƒå›´ï¼š50 äºº
- æ¶ˆæ¯å¤§å°ï¼šçº¦ 60 å­—èŠ‚
- å¸¦å®½ï¼š60 * 10 * 50 = 30 KB/s âš ï¸ éœ€è¦ä¼˜åŒ–

**ä¼˜åŒ–å»ºè®®**ï¼š
1. ä½¿ç”¨å¢é‡åŒæ­¥ï¼ˆåªå‘é€å˜åŒ–çš„å­—æ®µï¼‰
2. é™ä½å¹¿æ’­é¢‘ç‡ï¼ˆ5Hzï¼‰
3. ä½¿ç”¨ AOI åˆ†çº§ï¼ˆè¿‘å¤„é«˜é¢‘ï¼Œè¿œå¤„ä½é¢‘ï¼‰

---

### 5.2 æœåŠ¡ç«¯ CPU

**æ¯ä¸ªç©å®¶**ï¼š
- Tick é¢‘ç‡ï¼š20Hz
- æ¯æ¬¡ Tickï¼šä½ç½®è®¡ç®— + NavMesh æŸ¥è¯¢ + ç¢°æ’æ£€æµ‹
- ä¼°ç®—ï¼š0.1ms/Tick

**100 äººåŒå±**ï¼š
- æ€»è®¡ï¼š100 * 20 * 0.1ms = 200ms/ç§’ = 20% CPUï¼ˆå•æ ¸ï¼‰
- âš ï¸ éœ€è¦ä¼˜åŒ– NavMesh æŸ¥è¯¢

---

## 6. å®‰å…¨æ€§è¯„ä¼°

### 6.1 å¤–æŒ‚é£é™©

**é£é™©ç‚¹**ï¼š
1. å®¢æˆ·ç«¯å¯ä»¥å‘é€ä»»æ„ `MoveDir`ï¼ˆåŒ…æ‹¬è¶…è¿‡ 1.0 çš„å€¼ï¼‰
2. å®¢æˆ·ç«¯å¯ä»¥å‘é€è¶…é«˜é¢‘ç‡çš„è¾“å…¥
3. å®¢æˆ·ç«¯å¯ä»¥ä¿®æ”¹æœ¬åœ°é€Ÿåº¦

**é˜²æŠ¤æªæ–½**ï¼š
1. âœ… æœåŠ¡ç«¯æ ¡éªŒ `MoveDir` é•¿åº¦
2. âœ… æœåŠ¡ç«¯é™åˆ¶è¾“å…¥é¢‘ç‡
3. âœ… æœåŠ¡ç«¯ä½¿ç”¨è‡ªå·±çš„ `NumericComponent.Speed`
4. âš ï¸ éœ€è¦æ·»åŠ ï¼šå¼‚å¸¸ç§»åŠ¨æ£€æµ‹ï¼ˆç¬ç§»ã€ç©¿å¢™ï¼‰

---

### 6.2 ç½‘ç»œæ”»å‡»

**é£é™©ç‚¹**ï¼š
1. DDoSï¼šå¤§é‡å‘é€ `C2M_JoystickInput`
2. é‡æ”¾æ”»å‡»ï¼šé‡å¤å‘é€æ—§çš„è¾“å…¥

**é˜²æŠ¤æªæ–½**ï¼š
1. âœ… ä½¿ç”¨ `Seq` é˜²æ­¢é‡æ”¾
2. âš ï¸ éœ€è¦æ·»åŠ ï¼šé¢‘ç‡é™åˆ¶ï¼ˆæ¯ç§’æœ€å¤š 30 æ¡ï¼‰
3. âš ï¸ éœ€è¦æ·»åŠ ï¼šå¼‚å¸¸æ£€æµ‹ï¼ˆSeq è·³è·ƒè¿‡å¤§ï¼‰

---

## 7. æµ‹è¯•å»ºè®®

### 7.1 å•å…ƒæµ‹è¯•

```csharp
// æµ‹è¯• Seq æº¢å‡º
[Test]
public void Test_Seq_Overflow()
{
    int oldSeq = int.MaxValue - 10;
    int newSeq = -2147483640;  // æº¢å‡ºå
    Assert.IsTrue(IsSeqNewer(newSeq, oldSeq));
}

// æµ‹è¯•è¾“å…¥é¢‘ç‡é™åˆ¶
[Test]
public void Test_Input_Rate_Limit()
{
    // è¿ç»­å‘é€ 100 æ¡æ¶ˆæ¯
    // éªŒè¯åªæœ‰ 25 æ¡è¢«å¤„ç†ï¼ˆ25Hz é™åˆ¶ï¼‰
}

// æµ‹è¯• NavMesh å›è´´
[Test]
public void Test_NavMesh_Clamp()
{
    // å°è¯•ç§»åŠ¨åˆ°å¢™å¤–
    // éªŒè¯ä½ç½®è¢«å›è´´åˆ°å¢™å†…
}
```

---

### 7.2 å‹åŠ›æµ‹è¯•

1. **100 äººåŒå±ç§»åŠ¨**ï¼šéªŒè¯æœåŠ¡ç«¯ CPU å’Œå†…å­˜
2. **ç½‘ç»œæŠ–åŠ¨**ï¼šæ¨¡æ‹Ÿ 50% ä¸¢åŒ…ç‡ï¼ŒéªŒè¯ç§»åŠ¨æ˜¯å¦æ­£å¸¸
3. **é«˜å»¶è¿Ÿ**ï¼šæ¨¡æ‹Ÿ 500ms å»¶è¿Ÿï¼ŒéªŒè¯å®¢æˆ·ç«¯é¢„æµ‹æ•ˆæœ
4. **é•¿æ—¶é—´è¿è¡Œ**ï¼šè¿è¡Œ 24 å°æ—¶ï¼ŒéªŒè¯ Seq æº¢å‡ºã€å†…å­˜æ³„æ¼

---

## 8. å®æ–½å»ºè®®

### é˜¶æ®µ 1ï¼šä¿®æ­£å…³é”®é—®é¢˜ï¼ˆ1-2 å¤©ï¼‰

1. ç»Ÿä¸€åˆ° `MoveComponent`ï¼Œä¸æ–°å¢ `JoystickMoveComponent`
2. æ˜ç¡®æœåŠ¡ç«¯ Tick é¢‘ç‡ï¼ˆ20Hzï¼‰
3. å®ç°å®¢æˆ·ç«¯é¢„æµ‹
4. ä¼˜åŒ– NavMesh å›è´´ï¼ˆæ¡ä»¶å›è´´ï¼‰
5. ä¿®å¤ Seq æº¢å‡ºé—®é¢˜

### é˜¶æ®µ 2ï¼šå®ç°åŸºç¡€åŠŸèƒ½ï¼ˆ3-5 å¤©ï¼‰

1. å®ç°åè®®å’Œæ¶ˆæ¯å¤„ç†
2. å®ç°æœåŠ¡ç«¯ç§»åŠ¨ Tick
3. å®ç°å®¢æˆ·ç«¯è¾“å…¥ä¸ŠæŠ¥
4. å®ç°åŸºç¡€åŒæ­¥

### é˜¶æ®µ 3ï¼šä¼˜åŒ–å’Œæµ‹è¯•ï¼ˆ2-3 å¤©ï¼‰

1. æ·»åŠ è¾“å…¥é¢‘ç‡é™åˆ¶
2. æ·»åŠ å¼‚å¸¸ç§»åŠ¨æ£€æµ‹
3. ä¼˜åŒ–å¹¿æ’­é¢‘ç‡
4. å‹åŠ›æµ‹è¯•å’Œè°ƒä¼˜

### é˜¶æ®µ 4ï¼šé›†æˆå’ŒéªŒæ”¶ï¼ˆ1-2 å¤©ï¼‰

1. ä¸æŠ€èƒ½ç³»ç»Ÿé›†æˆ
2. ä¸ Buff ç³»ç»Ÿé›†æˆ
3. å®Œæ•´åŠŸèƒ½æµ‹è¯•
4. æ€§èƒ½éªŒæ”¶

**æ€»è®¡**ï¼š7-12 å¤©

---

## 9. æ€»ç»“

### âœ… æ–¹æ¡ˆä¼˜ç‚¹

1. æ¶æ„æ¸…æ™°ï¼ŒèŒè´£åˆ†ç¦»
2. æœåŠ¡ç«¯æƒå¨ï¼Œå®‰å…¨æ€§å¥½
3. è€ƒè™‘äº†é…ç½®åŒ–ï¼Œé¿å…ç¡¬ç¼–ç 
4. æœ‰å®Œæ•´çš„æµ‹è¯•è®¡åˆ’
5. æœ‰é£é™©è¯†åˆ«å’Œè§„é¿æªæ–½

### âŒ æ–¹æ¡ˆç¼ºé™·

1. **ç¼ºå°‘å®¢æˆ·ç«¯é¢„æµ‹**ï¼ˆä¸¥é‡å½±å“æ‰‹æ„Ÿï¼‰
2. **ç»„ä»¶å†²çªæœªè§£å†³**ï¼ˆMoveComponent vs JoystickMoveComponentï¼‰
3. **æ€§èƒ½ä¼˜åŒ–ä¸è¶³**ï¼ˆNavMesh æŸ¥è¯¢ã€å¹¿æ’­é¢‘ç‡ï¼‰
4. **å®‰å…¨é˜²æŠ¤ä¸è¶³**ï¼ˆè¾“å…¥é¢‘ç‡ã€å¼‚å¸¸æ£€æµ‹ï¼‰
5. **è¾¹ç•Œæƒ…å†µè€ƒè™‘ä¸è¶³**ï¼ˆSeq æº¢å‡ºã€æ–­çº¿é‡è¿ã€æŠ€èƒ½æ‰“æ–­ï¼‰

### ğŸ¯ æ ¸å¿ƒå»ºè®®

1. **ä¸è¦æ–°å¢ JoystickMoveComponent**ï¼Œæ‰©å±•ç°æœ‰ MoveComponent
2. **å¿…é¡»å®ç°å®¢æˆ·ç«¯é¢„æµ‹**ï¼Œå¦åˆ™æ‰‹æ„Ÿå¾ˆå·®
3. **ä¼˜åŒ– NavMesh å›è´´**ï¼Œé¿å…æ€§èƒ½é—®é¢˜
4. **æ·»åŠ å®‰å…¨é˜²æŠ¤**ï¼Œé˜²æ­¢å¤–æŒ‚å’Œæ”»å‡»
5. **è¡¥å……è¾¹ç•Œæƒ…å†µå¤„ç†**ï¼Œæé«˜å¥å£®æ€§

---

## 10. ä¿®æ­£åçš„æ–¹æ¡ˆè¦ç‚¹

```csharp
// 1. æ‰©å±• MoveComponentï¼ˆä¸æ–°å¢ç»„ä»¶ï¼‰
public class MoveComponent : Entity
{
    public MoveMode Mode;  // Path æˆ– Joystick
    public float3 JoystickDir;
    public int LastSeq;
    // ... å…¶ä»–å­—æ®µ
}

// 2. å®¢æˆ·ç«¯é¢„æµ‹
SendInput() -> ç«‹å³æœ¬åœ°ç§»åŠ¨ -> è®°å½•é¢„æµ‹å†å²
OnServerState() -> è®¡ç®—è¯¯å·® -> å¹³æ»‘å›æ­£

// 3. æœåŠ¡ç«¯ä¼˜åŒ–
Tick 20Hz -> æ¡ä»¶ NavMesh å›è´´ -> å˜åŒ–æ—¶å¹¿æ’­

// 4. å®‰å…¨é˜²æŠ¤
æ ¡éªŒè¾“å…¥åˆæ³•æ€§ -> é™åˆ¶é¢‘ç‡ -> æ£€æµ‹å¼‚å¸¸ç§»åŠ¨

// 5. è¾¹ç•Œå¤„ç†
Seq å¾ªç¯æ¯”è¾ƒ -> è¶…æ—¶åˆ†çº§ -> æŠ€èƒ½æ‰“æ–­ -> æ–­çº¿é‡è¿
```

---

**è¯„ä¼°äºº**ï¼šClaude Code
**è¯„ä¼°æ—¥æœŸ**ï¼š2026-03-01
**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0
