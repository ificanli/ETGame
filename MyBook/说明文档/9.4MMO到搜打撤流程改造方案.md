# 9.4 MMO到搜打撤流程改造方案

## 1. 文档目标与范围

本文档回答两个问题：

1. 当前项目（StateSync MMO线）的真实游玩流程是什么（基于代码事实）。
2. 如何把当前流程改造成“搜打撤竞技流程”：
   `登录 -> 战前准备 -> 匹配 -> 战斗/搜索物资 -> 死亡/撤离 -> （结算） -> 局外养成`。

说明：

- 本文档聚焦 `cn.etetet.statesync + cn.etetet.map` 主线，不把 `cn.etetet.lockstep` 作为当前流程，但会把它当作“可复用能力”。
- 方案遵循 ET ECS 规范：`Entity` 放数据，`System/Helper` 放逻辑。
- 所有阈值与规则要求配置化，避免硬编码。

---

## 2. 当前游戏流程（代码现状）

## 2.1 启动与客户端初始化
g
启动入口：

- `Packages/cn.etetet.statesync/Scripts/Hotfix/Share/Entry.cs`
- `Packages/cn.etetet.statesync/Scripts/HotfixView/Client/EntryEvent3_InitClient.cs`
- `Packages/cn.etetet.statesync/Scripts/Hotfix/Client/FiberInit_Client.cs`

关键行为：

1. 启动主 Fiber，创建 `SceneType.Client`。
2. Client 场景挂载基础组件：`PlayerComponent`、`CurrentScenesComponent`、`ObjectWait`、`QuestComponent`、`ItemComponent` 等。
3. 发布 `AppStartInitFinish`，进入 UI 初始化。

## 2.2 登录 UI 与登录链路

登录 UI 创建：

- `Packages/cn.etetet.statesync/Scripts/HotfixView/Client/YIUISystem/Login/AppStartInitFinish_CreateLoginUI.cs`
- `Packages/cn.etetet.statesync/Scripts/HotfixView/Client/YIUISystem/Login/LoginPanelComponentSystem.cs`

登录网络链路：

- 客户端登录入口：`Packages/cn.etetet.login/Scripts/Hotfix/Client/Login/LoginHelper.cs`
- NetClient 登录流程：`Packages/cn.etetet.login/Scripts/Hotfix/Client/NetClient/Main2NetClient_LoginHandler.cs`
- Realm 登录：`Packages/cn.etetet.login/Scripts/Hotfix/Server/Realm/C2R_LoginHandler.cs`
- Gate 登录：`Packages/cn.etetet.login/Scripts/Hotfix/Server/Gate/C2G_LoginGateHandler.cs`

流程概述：

1. 登录面板点击后调用 `LoginHelper.Login(...)`。
2. 先连 Realm 获取 Gate 地址和 Key，再连 Gate 完成玩家会话绑定。
3. 登录成功后发布 `LoginFinish`。
4. 打开 Lobby，关闭 Login：
   - `Packages/cn.etetet.statesync/Scripts/HotfixView/Client/YIUISystem/Lobby/LoginFinish_CreateLobbyUI.cs`
   - `Packages/cn.etetet.statesync/Scripts/HotfixView/Client/YIUISystem/Login/LoginFinish_RemoveLoginUI.cs`

## 2.3 Lobby 进图

入口：

- `Packages/cn.etetet.statesync/Scripts/HotfixView/Client/YIUISystem/Lobby/LobbyPanelComponentSystem.cs`
- `Packages/cn.etetet.map/Scripts/Hotfix/Client/EnterMapHelper.cs`

行为：

1. Lobby 按钮触发 `EnterMapHelper.EnterMapAsync`。
2. 发送 `C2G_EnterMap`，等待 `Wait_SceneChangeFinish`，完成后发 `EnterMapFinish`。

## 2.4 Gate 创建临时 Unit 并传送到 Map

入口：

- `Packages/cn.etetet.map/Scripts/Hotfix/Server/C2G_EnterMapHandler.cs`
- `Packages/cn.etetet.map/Scripts/Hotfix/Server/TransferHelper.cs`
- `Packages/cn.etetet.map/Scripts/Hotfix/Server/Map/M2M_UnitTransferRequestHandler.cs`

关键逻辑：

1. Gate 为玩家创建 GateMap 场景和临时 Unit。
2. 一帧末尾执行传送（避免返回包乱序）。
3. 默认传送到 `"Map2"`。
4. Map 侧收到传送后，给 Unit 挂载 `Turn/Move/Pathfinding/Mailbox/Target`，并下发 `M2C_StartSceneChange`（必要时 `M2C_CreateMyUnit`）。

## 2.5 地图分配机制（不是匹配）

入口：

- `Packages/cn.etetet.mapmanager/Scripts/Hotfix/Server/A2MapManager_GetMapRequestHandler.cs`
- `Packages/cn.etetet.mapmanager/Scripts/Hotfix/Server/MapManagerComponentSystem.cs`
- `Packages/cn.etetet.excel/Bundles/Luban/Config/Server/Json/MapConfigCategory.json`

现状机制：

1. `TransferHelper` 向 MapManager 请求可用地图副本。
2. `Map2` 当前配置 `CopyType = Line`，系统会优先塞入已有分线，人数不足再创建新线。
3. 这是“分线/副本分配”，不是“按规则匹配组成一局”。

## 2.6 客户端切场景与主玩法 UI

入口：

- `Packages/cn.etetet.map/Scripts/Hotfix/Client/M2C_StartSceneChangeHandler.cs`
- `Packages/cn.etetet.map/Scripts/Hotfix/Client/SceneChangeHelper.cs`
- `Packages/cn.etetet.map/Scripts/HotfixView/Client/Scene/SceneChangeStart_AddComponent.cs`
- `Packages/cn.etetet.map/Scripts/HotfixView/Client/Scene/SceneChangeFinishEvent_CreateUIHelp.cs`

行为：

1. 收到 `M2C_StartSceneChange` 后执行场景切换。
2. `SceneChangeStart` 时可开 Loading。
3. `SceneChangeFinish` 后打开 `MainPanel + HUDPanel`。

## 2.7 场内操作（移动/点击目标/战斗）

关键入口：

- 输入与移动：`Packages/cn.etetet.map/Scripts/HotfixView/Client/InputSystemComponentSystem.cs`
- 单位创建与本地玩家输入挂载：`Packages/cn.etetet.map/Scripts/HotfixView/Client/AfterUnitCreate_CreateUnitView.cs`
- 点击单位请求：`Packages/cn.etetet.map/Scripts/Hotfix/Server/Map/C2M_ClickUnitRequestHandler.cs`
- 客户端点击辅助：`Packages/cn.etetet.map/Scripts/Hotfix/Client/Unit/UnitClickHelper.cs`
- 服务器单位挂载组件：`Packages/cn.etetet.map/Scripts/Hotfix/Server/UnitFactory.cs`
- 伤害与死亡事件：`Packages/cn.etetet.spell/Scripts/Hotfix/Server/DamageHelper.cs`

现状特征：

1. 操作以“点击寻路 + 技能触发 + 任务交互”为主。
2. 玩家 `Unit` 挂载 `ItemComponent`、`QuestComponent`、`SpellComponent`、`BuffComponent` 等。
3. 伤害归零时发布 `UnitDie` 事件，但未形成“战局结束 -> 结算 -> 局外回写”完整闭环。

## 2.8 当前流程结论

当前主流程是：

`启动 -> 登录 -> Lobby -> 进入Map2（分线）-> 持续游玩（移动/任务/战斗）`

它更接近“持续世界/分线地图”，不等于“搜打撤局内局外闭环”。

---

## 3. 目标搜打撤流程定义

目标流程：

`登录 -> 战前准备 -> 匹配 -> 战斗/搜索物资 -> 死亡/撤离 -> （结算） -> 局外养成`

各阶段最小定义：

1. 登录：账号鉴权、角色加载、进入局外主界面。
2. 战前准备：仓库整理、装备装配、消耗品配置、保险/任务选择、入场费用校验。
3. 匹配：按模式/分组规则排队，组局成功后分配战局实例。
4. 战斗/搜索物资：局内时间限制、AI/玩家对抗、物资拾取、背包容量与风险管理。
5. 死亡/撤离：死亡直接结束个人战局；撤离按条件成功后带走局内收益。
6. 结算：统一计算收益/损失/任务推进/经验变化，生成可追踪结算记录。
7. 局外养成：将结算结果回写仓库、经济、成长系统，并返回战前准备。

---

## 4. 现状与目标差异矩阵

| 维度 | 当前 | 目标 | 改造要点 |
| --- | --- | --- | --- |
| 流程入口 | 登录后进 Lobby | 登录后进战前准备 | Lobby 语义替换为 RaidPrep |
| 进图方式 | 手动点“进图”，直接传送 Map2 | 先匹配，成功后进战局 | 新增匹配服务与队列状态 |
| 地图语义 | 分线长期存在 | 一局一实例、可终局 | MapCopy 生命周期改“会话化” |
| 胜负条件 | 无明确终局 | 死亡/撤离触发个人终局，战局计时结束全局终局 | 新增战局状态机 |
| 结算 | 无 | 有完整结算（带回/掉落/经验/任务） | 新增结算服务与持久化 |
| 局外成长 | 当前 Item/Quest 分散存在 | 明确“仓库-装配-养成”闭环 | 新增局外数据边界与UI |
| 反作弊边界 | 基础服务器权威 | 强化局内权威与回放校验 | 局内关键行为服务端裁决 |

---

## 5. 推荐改造总方案

## 5.1 总体原则

1. 保留现有登录和传送基础设施，减少底层重写成本。
2. 区分“局外数据”和“局内临时数据”，防止状态污染。
3. 所有规则配置化（匹配人数、撤离倒计时、战局时长、掉落概率等）。
4. 服务端权威：移动、拾取、伤害、撤离判定、结算计算都以服务器为准。

## 5.2 可复用能力（建议复用）

`cn.etetet.lockstep` 已有可复用的“匹配链路骨架”：

- Gate 收到匹配请求后转发 Match：`Packages/cn.etetet.lockstep/Scripts/Hotfix/Server/Gate/C2G_MatchHandler.cs`
- Match 聚合玩家并向 Map 申请房间：`Packages/cn.etetet.lockstep/Scripts/Hotfix/Server/Match/MatchComponentSystem.cs`
- Map 返回房间 ActorId：`Packages/cn.etetet.lockstep/Scripts/Hotfix/Server/Map/Match2Map_GetRoomHandler.cs`
- Match 通知 Gate 再通知客户端：`Match2G_NotifyMatchSuccess`

建议：

1. 复用“跨 Scene 消息流与队列形态”。
2. 不直接复用 lockstep 的战斗同步模型（搜打撤仍走你当前 map 权威模型）。
3. 新建面向搜打撤的 Match 规则层，避免把 `LSConstValue.MatchCount` 这类常量硬套过来。

## 5.3 目标状态机（玩家视角）

建议新增玩家状态机（服务端）：

```text
OutOfRaid
  -> Preparing
  -> Matching
  -> Deploying
  -> InRaid
     -> Dead
     -> Extracted
  -> Settling
  -> OutOfRaid
```

建议新增战局状态机（MapCopy/Session 视角）：

```text
Pending -> Loading -> Running -> Closing -> Settled -> Recycled
```

---

## 6. 包级改造建议

## 6.1 需要改造的现有包

1. `cn.etetet.statesync`
   - 新增战前准备/匹配/结算 UI 面板与事件流。
   - 把现有 Lobby 语义迁移到 RaidPrep。
2. `cn.etetet.map`
   - 新增战局内规则：撤离点、局内计时、死亡终局、战利品归属。
   - 扩展传送与战局 Session 绑定逻辑。
3. `cn.etetet.mapmanager`
   - 扩展“地图分配”为“战局实例分配”。
   - Raid 地图建议 `CopyType = Copy`，避免 Line 合线干扰公平性。
4. `cn.etetet.item`
   - 区分“局外仓库”与“局内背包快照/掉落”。
5. `cn.etetet.quest`（如需要）
   - 支持战局类任务事件（撤离成功、携出指定物资等）。
6. `cn.etetet.excel`
   - 增加 Raid 相关配置表（见第 8 节）。

## 6.2 可选新增包（推荐）

建议新增 `cn.etetet.raid`（或等价命名）承载搜打撤业务聚合逻辑，避免把逻辑打散在 map/item/quest 中。

建议职责：

1. `RaidSessionComponent`：战局元数据与玩家列表。
2. `RaidMatchFacade`：匹配入口与回调。
3. `RaidSettlementHelper`：统一结算计算与落库。
4. `RaidProgressComponent`：局外养成进度。

依赖注意：

1. 依赖关系需写入 `package.json`。
2. 递归依赖必须补齐。
3. 禁止反向依赖高层包。

---

## 7. 流程改造设计（按阶段）

## 7.1 登录（保留，少改）

保留当前链路：

- `LoginPanel -> LoginHelper -> Realm/Gate`

改造点：

1. `LoginFinish` 后不再默认打开旧 Lobby，而是打开 `RaidPrepPanel`。
2. 客户端初始化时加载“局外仓库与角色状态摘要”。

## 7.2 战前准备（新增主流程）

新能力：

1. 读取仓库、装备位、消耗品、保险状态。
2. 形成“入场快照”（Loadout Snapshot）。
3. 发送 `C2G_RaidReady`（含模式、装备摘要、可选队伍信息）。

服务端校验：

1. 物品合法性（归属、数量、耐久、锁定状态）。
2. 入场条件（等级、门票、冷却）。
3. 装备冲突（重复占位、非法组合）。

## 7.3 匹配（新增）

新链路建议：

1. Gate 收到 `C2G_RaidMatch`。
2. 转发到 Match Scene。
3. Match 按模式/段位/队伍人数做分桶。
4. 组局成功后向 MapManager 申请 Raid MapCopy（一局一副本）。
5. Match 通知 Gate -> 客户端进入 `Deploying`。

关键建议：

1. 队列规则配置化（超时、放宽范围、机器人补位策略可选）。
2. 支持取消匹配与断线重连恢复。

## 7.4 战斗/搜索物资（局内）

局内核心对象：

1. `RaidSession`（战局实体，挂在 MapCopy 或其子实体）。
2. `RaidPlayerState`（每个玩家：Alive/Dead/Extracted）。
3. `RaidInventoryRuntime`（局内拾取变化集）。

局内规则建议：

1. 战局开始时记录每人入场快照。
2. 物资拾取服务端校验（距离、权属、容量、并发互斥）。
3. 死亡时冻结角色并生成“可掠夺容器”。
4. 战局定时器控制 Closing 阶段。

## 7.5 死亡/撤离（新增终局分支）

死亡分支：

1. 监听现有 `UnitDie` 事件（`DamageHelper` 已发布）。
2. 标记玩家战局失败状态并锁定局内物品处理策略。
3. 若全队死亡可提前结束个人等待。

撤离分支：

1. 增加撤离点配置与激活条件（常驻/限时/道具触发）。
2. 玩家发起撤离请求 -> 服务端开始撤离进度条。
3. 进度条期间受击/离点可中断。
4. 成功后标记 `Extracted`，进入结算队列。

## 7.6 结算（新增）

统一结算输入：

1. 入场快照
2. 局内变更集（获得/消耗/丢失）
3. 死亡或撤离结果
4. 任务与成就事件流

统一结算输出：

1. 携出物资列表
2. 损失列表
3. 货币/经验变化
4. 任务推进结果
5. 战报（可回看）

## 7.7 局外养成（新增闭环）

落地建议：

1. 结算后将结果写回局外仓库/经济/成长组件。
2. 返回 `RaidPrepPanel`，允许连续开局。
3. UI 展示“结算 -> 仓库变化 -> 下局准备”连续路径。

---

## 8. 配置与协议改造建议

## 8.1 Excel/Luban 配置（建议新增）

建议表：

1. `RaidModeConfig`：模式人数、时长、开放时间、匹配参数。
2. `RaidMapConfig`：地图池、出生点组、天气/时间段。
3. `RaidExtractionConfig`：撤离点位置、开放条件、倒计时、交互距离。
4. `RaidLootPoolConfig`：容器与掉落池、稀有度、刷新规则。
5. `RaidSettlementRuleConfig`：死亡/撤离收益结算规则。
6. `RaidLoadoutRuleConfig`：装备限制、违禁品、保险规则。

## 8.2 协议（建议新增族）

建议新增协议簇（命名示例）：

1. 匹配：
   - `C2G_RaidMatch`
   - `G2C_RaidMatchQueued`
   - `G2C_RaidMatchSuccess`
   - `C2G_RaidMatchCancel`
2. 局内：
   - `C2M_RaidExtractRequest`
   - `M2C_RaidExtractProgress`
   - `M2C_RaidStateSync`
3. 结算：
   - `M2C_RaidSettlement`
   - `C2G_RaidSettlementAck`

建议：

1. 协议字段要保留可扩展空间（版本号、扩展 map、错误码）。
2. 不把客户端可篡改字段作为最终判定依据。

---

## 9. 实施路线（可直接执行）

## Phase 1：最小可玩闭环（推荐先做）

目标：

`登录 -> 战前准备(简化) -> 匹配 -> 进局 -> 死亡/撤离二选一 -> 结算 -> 回战前准备`

工作项：

1. UI：新增 `RaidPrepPanel`、`RaidMatchingPanel`、`RaidSettlementPanel`。
2. 服务端：新增匹配入口与战局 Session 管理。
3. Map：实现撤离点交互与死亡终局。
4. 结算：先做简化版（仅带回/丢失和基础货币）。

验收标准：

1. 能完整跑通至少 1 局。
2. 死亡与撤离两条分支都能产生结算。
3. 结算结果可回写并在 UI 可见。

## Phase 2：完善经济与物资系统

工作项：

1. 局内容器、掉落池、稀有度规则。
2. 仓库容量、堆叠规则、丢弃与保险逻辑。
3. 战局日志与异常补偿机制。

## Phase 3：成长与长线目标

工作项：

1. 局外任务线与赛季目标。
2. 角色成长（技能树/天赋/被动）与战局关联。
3. 统计报表与平衡性参数调优。

---

## 10. 关键风险与规避建议

1. 风险：继续使用 `Map2` 的 `CopyType = Line` 可能触发合线，不适合“公平对局”。
   - 建议：Raid 地图改为 `CopyType = Copy`，禁用合线逻辑。

2. 风险：当前传送会移除非 `ITransfer` 组件，局内状态可能丢失。
   - 证据：`Packages/cn.etetet.map/Scripts/Hotfix/Server/TransferHelper.cs`
   - 建议：跨场景保留的数据组件实现 `ITransfer`，或避免战局内跨场景传送。

3. 风险：匹配逻辑若直接复制 lockstep 常量会形成硬编码。
   - 建议：匹配参数全部配置化，按模式动态取值。

4. 风险：结算口径分散在多个系统导致对账困难。
   - 建议：统一走 `RaidSettlementHelper`，只保留一个“最终写库入口”。

5. 风险：断线重连时状态不一致。
   - 建议：为 `Matching`、`InRaid`、`Settling` 三态设计重连恢复协议。

---

## 11. 测试与验收建议

建议优先补自动化测试（`cn.etetet.test`）：

1. 登录后进入战前准备状态测试。
2. 匹配成功并分配唯一战局实例测试。
3. 死亡分支结算一致性测试。
4. 撤离分支结算一致性测试。
5. 断线重连恢复状态测试。
6. 并发拾取冲突测试。
7. 结算幂等测试（重复提交不重复发奖）。

上线前验收（DoD）：

1. 主流程 100% 可闭环，无人工干预。
2. 任一异常退出都有可恢复策略。
3. 关键配置可热更新，不改代码可调参。
4. 无新增硬编码规则。

---

## 12. 第一阶段建议改动清单（文件级）

以下是可直接开工的“第一阶段”落点建议：

1. UI 路由
   - 修改 `Packages/cn.etetet.statesync/Scripts/HotfixView/Client/YIUISystem/Lobby/LoginFinish_CreateLobbyUI.cs`
   - 新增 `RaidPrepPanel` 相关组件与系统（放在 `statesync` 的 YIUI 目录）

2. 客户端请求入口
   - 在 `statesync` 新增匹配按钮事件，发送 `C2G_RaidMatch`
   - 保留 `EnterMapHelper`，新增“匹配成功后进局”入口

3. 服务端匹配
   - 参考 `cn.etetet.lockstep` 的 Match 链路，新建 Raid 匹配 Handler 与 Component
   - Gate 增加 `C2G_RaidMatch` 处理

4. Map 战局状态
   - 在 `cn.etetet.map` 增加 `RaidSessionComponent` 与系统
   - 在 `UnitDie` 事件链上挂接战局终局逻辑

5. 结算回写
   - 新增简化 `RaidSettlementHelper`（统一入口）
   - 最小化接入 `item/quest` 写回逻辑

6. 配置
   - 在 `excel` 新增最小配置：模式人数、战局时长、撤离点倒计时

---

## 13. 补充说明

1. 当前项目已经有“登录、进图、地图分配、战斗基础链路”，改造重点不是“从零搭网络层”，而是“补齐局内局外闭环”。
2. 推荐先做最小闭环，再逐步扩展物资深度和养成深度，避免一次性重构导致长时间不可玩。
